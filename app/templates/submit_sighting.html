{% extends "base.html" %}

{% block title %}Submit Cat Sighting - Hawaii Cats{% endblock %}

{% block head %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='css/map.css') }}">
<script src="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.js"></script>
<link href="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.css" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <h1 class="text-3xl font-bold mb-8 text-gray-900 dark:text-white">Submit a Cat Sighting</h1>
    
    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
        <!-- Map Section -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-4">
            <h2 class="text-xl font-semibold mb-4 text-gray-900 dark:text-white">Select Location</h2>
            <div id="map" class="w-full h-96 rounded-lg mb-4"></div>
            <p class="text-sm text-gray-600 dark:text-gray-400">Click on the map to set the location of your cat sighting</p>
        </div>

        <!-- Form Section -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-4">
            <form id="sightingForm" class="space-y-6">
                <input type="hidden" id="latitude" name="latitude" required>
                <input type="hidden" id="longitude" name="longitude" required>

                <div>
                    <label for="visibleCats" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Number of Cats Seen</label>
                    <input type="number" id="visibleCats" name="visibleCats" min="1" required
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                </div>

                <div>
                    <label for="locationType" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Location Type</label>
                    <select id="locationType" name="locationType" required
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        <option value="residential">Residential Area</option>
                        <option value="park">Park</option>
                        <option value="beach">Beach</option>
                        <option value="business">Business Area</option>
                        <option value="other">Other</option>
                    </select>
                </div>

                <div>
                    <label for="timeSpent" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Time Spent Observing</label>
                    <select id="timeSpent" name="timeSpent" required
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        <option value="quick">Quick Glance (< 1 min)</option>
                        <option value="brief">Brief (1-5 mins)</option>
                        <option value="moderate">Moderate (5-15 mins)</option>
                        <option value="extended">Extended (> 15 mins)</option>
                    </select>
                </div>

                <div>
                    <label for="movementLevel" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Cat Movement Level</label>
                    <select id="movementLevel" name="movementLevel" required
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        <option value="stationary">Stationary</option>
                        <option value="low">Low Movement</option>
                        <option value="moderate">Moderate Movement</option>
                        <option value="high">High Movement</option>
                    </select>
                </div>

                <div>
                    <label for="notes" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Additional Notes</label>
                    <textarea id="notes" name="notes" rows="3"
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                            placeholder="Any additional observations or details..."></textarea>
                </div>

                <div>
                    <button type="submit"
                            class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        Submit Sighting
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Initialize the map
    const map = initializeMap('map');
    let marker = null;

    // Handle map clicks to set location
    map.on('click', (e) => {
        const lngLat = e.lngLat;
        
        // Update hidden form fields
        document.getElementById('latitude').value = lngLat.lat;
        document.getElementById('longitude').value = lngLat.lng;

        // Update or create marker
        if (marker) {
            marker.setLngLat(lngLat);
        } else {
            marker = new mapboxgl.Marker()
                .setLngLat(lngLat)
                .addTo(map);
        }
    });

    // Handle form submission
    document.getElementById('sightingForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        // Get form data
        const formData = new FormData(e.target);
        const data = {
            coordinate: {
                latitude: parseFloat(formData.get('latitude')),
                longitude: parseFloat(formData.get('longitude'))
            },
            visibleCats: parseInt(formData.get('visibleCats')),
            locationType: formData.get('locationType'),
            timeSpent: formData.get('timeSpent'),
            movementLevel: formData.get('movementLevel'),
            notes: formData.get('notes'),
            timestamp: new Date().toISOString(),
            species: 'cat'
        };

        try {
            const response = await fetch('/api/sightings', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            });

            if (response.ok) {
                alert('Sighting submitted successfully!');
                window.location.href = '/catmap';
            } else {
                throw new Error('Failed to submit sighting');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Failed to submit sighting. Please try again.');
        }
    });
</script>
{% endblock %}
